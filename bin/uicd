#!/usr/bin/perl
# Copyright (c) 2012, Mitchell Cooper

use warnings;
use strict;
use utf8;

local ($0,     $SIG{TERM},        $SIG{KILL},        $SIG{PIPE}        ) =
      ('uicd', \&UICd::terminate, \&UICd::terminate, \&UICd::signalpipe);
local ($SIG{HUP},         $SIG{__WARN__}                               ) =
      (\&UICd::signalhup, \&UICd::WARNING                              );

our (
    $run_dir,           # the UICd running directory
    %dir,               # a hash of data directories
    $loop,              # the IO::Async loop
    %conf,              # the UICd configuration values
    $UICd,              # the UICd instance
    @loaded_modules,    # an array of loaded UICd modules
    $server,            # this uicd's server object
);

sub reloadable (&&);

BEGIN {

    # find the directory to run from.
    if ( not defined ($run_dir = shift @ARGV) ) {
        die "No directory specified.\n";
    }

    # make sure the run directory exists.
    if (!-d $run_dir) {
        die "Run directory does not exist.\n";
    }

    $dir{etc} = "$run_dir/etc";
    $dir{bin} = "$run_dir/bin";
    $dir{lib} = "$run_dir/lib";
    $dir{run} = "$run_dir/etc";
    $dir{mod} = "$run_dir/mod";
    $dir{libuic} = "$run_dir/libuic";
    $dir{eventedobject} = "$run_dir/evented-object";

    chdir $run_dir or die "Can't access run directory.\n";
    unshift @INC, $dir{lib}, $dir{libuic}, $dir{eventedobject};

    require UICd;
    UICd::begin();
}

UICd::boot();
UICd::loop();
